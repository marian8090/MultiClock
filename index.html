<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>MultiClock</title>
    <script src="https://pixijs.download/release/pixi.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000000;
            font-family: Arial, sans-serif;
        }

        #clock-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #clock-number {
            position: fixed;
            bottom: 20px;
            right: 20px;
            color: #00ff00;
            font-size: 18px;
            z-index: 1000;
            font-family: Arial, sans-serif;
            opacity: 0.8;
        }

        #help-overlay {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #00ff00;
            font-size: 14px;
            z-index: 2000;
            font-family: 'Courier New', Courier, monospace;
            opacity: 0.9;
            white-space: pre;
            line-height: 1.4;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
            border-radius: 4px;
            display: none;
        }

        canvas {
            display: block;
        }
    </style>
</head>
<body>

    <div id="clock-container"></div>
    <div id="clock-number">1</div>

    <div id="help-overlay">MultiClock Controls
1: Analog Clock
2: Digital Clock
3: 7-Segment LED
4: Slim Analog
5: DSEG Clock
↑↓: Navigate parameters
←→: Change values
F: Toggle fullscreen
H: Show this help</div>

    <script type="module">
        // Dynamic imports with cache busting
        const cacheBuster = Date.now();
        const AnalogClockModule = await import(`./clocks/1_analog-clock.js?v=${cacheBuster}`);
        const DigitalClockModule = await import(`./clocks/2_digital-clock.js?v=${cacheBuster}`);
        const SevenSegmentLedClockModule = await import(`./clocks/3_7segment-led.js?v=${cacheBuster}`);
        const AviationClockModule = await import(`./clocks/4_aviation-clock.js?v=${cacheBuster}`);
        const DSEGClockModule = await import(`./clocks/5_dseg-clock.js?v=${cacheBuster}`);

        const { AnalogClock } = AnalogClockModule;
        const { DigitalClock } = DigitalClockModule;
        const { SevenSegmentLedClock } = SevenSegmentLedClockModule;
        const { AviationClock } = AviationClockModule;
        const { DSEGClock } = DSEGClockModule;

        // Settings Manager for persisting user preferences
        class SettingsManager {
            constructor() {
                this.prefix = 'multiclock_';
            }

            // Save settings for a specific clock
            saveClockSettings(clockIndex, settings) {
                try {
                    const key = `${this.prefix}clock${clockIndex + 1}`;
                    console.log(`[SettingsManager] Saving settings for clock ${clockIndex + 1}:`, settings);
                    localStorage.setItem(key, JSON.stringify(settings));
                    console.log(`[SettingsManager] Successfully saved to localStorage key: ${key}`);
                } catch (e) {
                    console.warn('Failed to save clock settings:', e);
                }
            }

            // Load settings for a specific clock
            loadClockSettings(clockIndex) {
                try {
                    const key = `${this.prefix}clock${clockIndex + 1}`;
                    const saved = localStorage.getItem(key);
                    const parsed = saved ? JSON.parse(saved) : null;
                    console.log(`[SettingsManager] Loading settings for clock ${clockIndex + 1}:`, parsed);
                    return parsed;
                } catch (e) {
                    console.warn('Failed to load clock settings:', e);
                    return null;
                }
            }

            // Save the currently selected clock index
            saveSelectedClock(clockIndex) {
                try {
                    localStorage.setItem(`${this.prefix}selected`, clockIndex.toString());
                } catch (e) {
                    console.warn('Failed to save selected clock:', e);
                }
            }

            // Load the last selected clock index
            loadSelectedClock() {
                try {
                    const saved = localStorage.getItem(`${this.prefix}selected`);
                    return saved !== null ? parseInt(saved, 10) : null;
                } catch (e) {
                    console.warn('Failed to load selected clock:', e);
                    return null;
                }
            }
        }

        class MultiClock {
            constructor() {
                this.clocks = [
                    { name: 'Analog', class: AnalogClock },
                    { name: 'Digital', class: DigitalClock },
                    { name: '7-Segment LED', class: SevenSegmentLedClock },
                    { name: 'Slim Analog', class: AviationClock },
                    { name: 'DSEG', class: DSEGClock }
                ];
                this.currentClockIndex = 0;
                this.currentClockInstance = null;
                this.container = document.getElementById('clock-container');
                this.clockNumberDisplay = document.getElementById('clock-number');
                this.helpOverlay = document.getElementById('help-overlay');
                this.helpTimeout = null;
                this.settingsManager = new SettingsManager();

                this.setupEventListeners();
                this.setupBeforeUnloadHandler();

                // Load last selected clock or default to 0
                const savedClockIndex = this.settingsManager.loadSelectedClock();
                const initialClockIndex = (savedClockIndex !== null && savedClockIndex >= 0 && savedClockIndex < this.clocks.length)
                    ? savedClockIndex
                    : 0;
                this.loadClock(initialClockIndex);
            }

            setupBeforeUnloadHandler() {
                // Save settings when closing the tab/window or navigating away
                window.addEventListener('beforeunload', () => {
                    if (this.currentClockInstance && typeof this.currentClockInstance.getSettings === 'function') {
                        const settings = this.currentClockInstance.getSettings();
                        this.settingsManager.saveClockSettings(this.currentClockIndex, settings);
                    }
                });
            }

            setupEventListeners() {
                document.addEventListener('keydown', (event) => {
                    switch(event.key) {
                        case '1':
                        case '2':
                        case '3':
                        case '4':
                        case '5':
                            const clockIndex = parseInt(event.key) - 1;
                            if (clockIndex >= 0 && clockIndex < this.clocks.length) {
                                this.switchToClock(clockIndex);
                            }
                            this.hideHelp();
                            break;

                        case 'ArrowUp':
                            if (this.currentClockInstance && this.currentClockInstance.navigateParameterUp) {
                                this.currentClockInstance.navigateParameterUp();
                            }
                            this.hideHelp();
                            break;

                        case 'ArrowDown':
                            if (this.currentClockInstance && this.currentClockInstance.navigateParameterDown) {
                                this.currentClockInstance.navigateParameterDown();
                            }
                            this.hideHelp();
                            break;

                        case 'ArrowLeft':
                            if (this.currentClockInstance && this.currentClockInstance.changeParameterLeft) {
                                this.currentClockInstance.changeParameterLeft();
                            }
                            this.hideHelp();
                            break;

                        case 'ArrowRight':
                            if (this.currentClockInstance && this.currentClockInstance.changeParameterRight) {
                                this.currentClockInstance.changeParameterRight();
                            }
                            this.hideHelp();
                            break;

                        case 'f':
                        case 'F':
                            this.toggleFullscreen();
                            this.hideHelp();
                            break;

                        case 'h':
                        case 'H':
                            this.showHelp();
                            break;
                    }
                });

                // Auto-enter fullscreen on load
                document.addEventListener('DOMContentLoaded', () => {
                    setTimeout(() => this.enterFullscreen(), 100);
                });
            }

            async loadClock(index) {
                console.log(`[MultiClock] loadClock called for index ${index}`);

                if (this.currentClockInstance) {
                    // Save settings before destroying
                    if (typeof this.currentClockInstance.getSettings === 'function') {
                        const settings = this.currentClockInstance.getSettings();
                        console.log(`[MultiClock] Getting settings from current clock ${this.currentClockIndex + 1}:`, settings);
                        this.settingsManager.saveClockSettings(this.currentClockIndex, settings);
                    }
                    this.currentClockInstance.destroy();
                    this.clearContainer();
                }

                this.currentClockIndex = index;
                const ClockClass = this.clocks[index].class;
                this.currentClockInstance = new ClockClass();

                // Setup settings manager reference BEFORE init so it's available during initialization
                this.currentClockInstance.settingsManager = this.settingsManager;
                this.currentClockInstance.clockIndex = index;

                // Load saved settings if available
                const savedSettings = this.settingsManager.loadClockSettings(index);
                console.log(`[MultiClock] Passing savedSettings to clock ${index + 1} init:`, savedSettings);

                try {
                    await this.currentClockInstance.init(this.container, savedSettings);
                    this.updateClockNumber();

                    // Save the selected clock index
                    this.settingsManager.saveSelectedClock(index);
                } catch (error) {
                    console.error('Failed to load clock:', error);
                }
            }

            switchToClock(index) {
                if (index !== this.currentClockIndex) {
                    this.settingsManager.saveSelectedClock(index);
                    this.loadClock(index);
                }
            }

            updateClockNumber() {
                this.clockNumberDisplay.textContent = (this.currentClockIndex + 1).toString();
            }


            clearContainer() {
                while (this.container.firstChild) {
                    this.container.removeChild(this.container.firstChild);
                }
            }

            showHelp() {
                this.helpOverlay.style.display = 'block';

                // Clear existing timeout
                if (this.helpTimeout) {
                    clearTimeout(this.helpTimeout);
                }

                // Auto-hide after 3 seconds
                this.helpTimeout = setTimeout(() => {
                    this.hideHelp();
                }, 3000);
            }

            hideHelp() {
                this.helpOverlay.style.display = 'none';
                if (this.helpTimeout) {
                    clearTimeout(this.helpTimeout);
                    this.helpTimeout = null;
                }
            }


            enterFullscreen() {
                const element = document.documentElement;
                if (element.requestFullscreen) {
                    element.requestFullscreen();
                } else if (element.mozRequestFullScreen) {
                    element.mozRequestFullScreen();
                } else if (element.webkitRequestFullscreen) {
                    element.webkitRequestFullscreen();
                } else if (element.msRequestFullscreen) {
                    element.msRequestFullscreen();
                }
            }

            exitFullscreen() {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }

            toggleFullscreen() {
                if (!document.fullscreenElement && !document.mozFullScreenElement &&
                    !document.webkitFullscreenElement && !document.msFullscreenElement) {
                    this.enterFullscreen();
                } else {
                    this.exitFullscreen();
                }
            }
        }

        // Initialize MultiClock when the page loads
        window.addEventListener('load', () => {
            new MultiClock();
        });
    </script>
</body>
</html>